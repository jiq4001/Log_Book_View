"0","server <- function(input, output) {"
"0","###########"
"0","# cleaned data all "
"0","###########"
"0","  req(input$file)"
"0","  df3 <- reactive({"
"0","    df <- read.csv(input$file$datapath,"
"0","                 header = input$header,"
"0","                 sep = input$sep,"
"0","                 quote = input$quote)"
"0","          #df<- read.csv(""Log_Book_Final.csv"")"
"0","colnames(df())<- c(""Proc.By"", ""Time.Drawn"", ""Date.Drawn"", ""Date.Proc"", ""Time.Rec"", ""Time.Proc"", ""Trial"", ""Site"", ""ON_Scheduled"")"
"0","###############"
"0","# Clear blank char and "
"0","# fill missing input"
"0","###############"
"0","df$Proc.By<- substr(str_trim(df$Proc.By, ""both""), 1, 2)"
"0","df[, ""ON_Scheduled""]<- str_trim(toupper(df[, ""ON_Scheduled""])) "
"0","df$ON_Scheduled <- as.character(df$ON_Scheduled)"
"0","df$ON_Scheduled[which(df$ON_Scheduled != ""YES"")]<- ""NO"""
"0","###############"
"0","# Coerce Date format"
"0","###############"
"0","df%>% mutate(Proc.By= substr(str_trim(df$Proc.By, ""both""), 1, 2), "
"0","                 Drawn= as.POSIXct(paste(df$Date.Drawn, df$Time.Drawn), format=""%m / %d / %Y %H : %M""),"
"0","                 Rec= as.POSIXct(paste(df$Date.Drawn, df$Time.Rec), format=""%m / %d / %Y %H : %M""),"
"0","                 Proc= as.POSIXct(paste(df$Date.Proc, df$Time.Proc), format=""%m / %d / %Y %H : %M""),"
"0","                 Trial= str_trim(df$Trial), "
"0","                 Site= toupper(str_trim(df$Site)"
"0","                 ) ) %>%"
"0","  drop_na()%>%"
"0","  select(Proc.By, Date.Proc, Drawn, Rec, Proc, Trial, Site, ON_Scheduled, Time.Rec) -> df11"
"0","###############"
"0","# Clean String input information"
"0","###############"
"0","#unique(df11$Site)"
"0","df11$Site <- case_when("
"0","  str_detect(df11$Site, ""(EXT)"") ~ ""EXTERNAL"","
"0","  df11$Site %in% c(""WOLCHOK LAB"", ""MANHATTAN"", ""NYP"", ""WCMC CTRU"", ""MAIN"") ~ ""MAIN"","
"0","  str_detect(df11$Site, ""(BASKING RIDGE)"") | str_detect(df11$Site, ""(BSK)"") ~ ""BASKING_RIDGE"","
"0","  str_detect(df11$Site, ""(LVH)"") | str_detect(df11$Site, ""(LEHIGH)"")~ ""LEHIGH_VALLEY"","
"0","  str_detect(df11$Site, ""(53)"") | str_detect(df11$Site, ""(35)"")~ ""53RD ST"","
"0","  str_detect(df11$Site, ""(60)"")  ~ ""60TH_ST"","
"0","  str_detect(df11$Site, ""(68)"")  ~ ""68TH_ST"","
"0","  str_detect(df11$Site, ""(64)"")  ~ ""64TH_ST"","
"0","  str_detect(df11$Site, ""(BER)"")  ~ ""BERGEN"","
"0","  str_detect(df11$Site, ""(NOR)"")  ~ ""NORTHWELL"","
"0","  str_detect(df11$Site, ""(WES)"") | str_detect(df11$Site, ""(WST)"") ~ ""WESTCHESTER"","
"0","  str_detect(df11$Site, ""(NAS)"")  ~ ""NASSAU"","
"0","  str_detect(df11$Site, ""(MON)"")  ~ ""MONMOUTH"","
"0","  str_detect(df11$Site, ""(RVC)"") | str_detect(df11$Site, ""(ROC)"") ~ ""ROCKVILLE"","
"0","  str_detect(df11$Site, ""(KI)"")  ~ ""KIMMEL"","
"0","  str_detect(df11$Site, ""(HAR)"")  ~ ""HARTFORD"","
"0","  str_detect(df11$Site, ""(COM)"") | str_detect(df11$Site, ""(CMK)"")  ~ ""COMMACK"","
"0","  TRUE ~ ""OTHER"""
"0",")"
"0","###############"
"0","# Create vars for summary"
"0","###############"
"0","df11 %>% mutate(Date.Proc = as.Date(Date.Proc, format = ""%m/%d/%Y""),"
"0","                Year = factor(year(Proc)), "
"0","                Month = month(Proc), "
"0","                "
"0","                Weekday = factor(wday(Proc), levels = c(2, 3, 4, 5, 6), labels = c(""Mon"", ""Tue"", ""Wed"", ""Thur"", ""Fri"")), "
"0","                Week = factor(week(Proc)), "
"0","                Draw.Rec = round(difftime(Rec, Drawn, units = ""hours""), 1),"
"0","                Draw.Rec = ifelse(Draw.Rec <= 0, NA, Draw.Rec),"
"0","                Proc.Rec = round(difftime(Proc, Rec, units = ""hours""), 1), "
"0","                Proc.Rec = ifelse(Proc.Rec < 0, NA, Proc.Rec),"
"0","                OverNight_Proc = ifelse(Proc.Rec> 10, ""YES"", ""NO"") ) %>%"
"0","  drop_na_(c(""Draw.Rec"", ""Proc.Rec""))-> df3"
"0","df3$Month <- factor(df3$Month)"
"0","df3"
"0","  })"
"0","  "
"0","  "
"0","  "
"0","  output$cleandata <- DT::renderDataTable({"
"0","    datatable(df3())"
"0","  })"
"0","###########"
"0","# trend all "
"0","###########  "
"0","  output$plot_all<- renderPlot({ "
"0","    df3() %>%"
"0","        group_by(Date.Proc) %>%"
"0","        summarise(Daily = n()) %>%"
"0","        inner_join(df3 %>% select(Date.Proc, Year))%>%"
"0","        unique() %>%"
"0","        group_by(Year) %>%"
"0","        ggplot()+"
"0","        geom_line(aes(Date.Proc, Daily, color = Year))+"
"0","        geom_smooth(aes(Date.Proc, Daily, color = Year), method = ""lm"", se = F)+"
"0","        theme_classic()"
"0","  })"
"0","###########"
"0","# 1 factor pie chart with time range "
"0","###########    "
"0","  pie_data <- reactive({"
"0","    len <- ifelse(length(unique(df3[, input$pie_f1])) > 12, 12, length(unique(df3[, input$pie_f1])))"
"0","    df <- df3() %>%"
"0","      filter(Date.Proc >= input$date_range[[1]] & Date.Proc <= input$date_range[[2]])%>%"
"0","      select(!!rlang::sym(input$pie_f1)) %>%"
"0","      group_by(!!rlang::sym(input$pie_f1)) %>%"
"0","      summarise(total = n()) %>%"
"0","      arrange(desc(total)) %>%"
"0","      head(len)"
"0","    df"
"0","  })"
"0","   output$plot_by1<- renderPlot({ "
"0","     pie_data() %>%"
"0","     ggplot(aes(x= """", y = total, fill= !!rlang::sym(input$pie_f1)))+"
"0","     geom_bar(width = 1, stat = ""identity"",color=""white"")+"
"0","     coord_polar(""y"")+"
"0","     theme_void()  "
"0","  })"
"0","###########"
"0","# 2 factor bar chart with time range "
"0","###########    "
"0","   bar_data <- reactive({"
"0","     df <- df3() %>%"
"0","       filter(Date.Proc >= input$date_range1[[1]] & Date.Proc <= input$date_range1[[2]])"
"0","     df <- df %>%"
"0","       select(!!!rlang::sym(input$sort_by[[1]]), !!!rlang::sym(input$sort_by[[2]])) %>%"
"0","       cbind.data.frame(group = paste(df[, input$sort_by[[1]]], df[, input$sort_by[[2]]], sep = "",""))%>%"
"0","       group_by(group)%>%"
"0","       summarise(total = n())%>%"
"0","       separate(group, into = c(input$sort_by[[1]], input$sort_by[[2]]), sep = "","")"
"0","     df"
"0","   })"
"0","   "
"0"," "
"0","    output$plot_by2<- renderPlot({ "
"0","     req(input$sort_by)"
"0","     bar_data() %>%"
"0","     ggplot()+"
"0","     geom_bar(aes_string(input$sort_by[[1]], input$sort_by[[2]], fill = input$sort_by[[1]]), stat = ""identity"")+"
"0","     theme("
"0","      panel.grid.major = element_blank(), "
"0","      panel.grid.minor = element_blank(), "
"0","      axis.title.y = element_blank(),"
"0","      axis.text.y = element_blank(),"
"0","      panel.background = element_blank(),"
"0","      axis.text.x = element_text(angle = 90, hjust = 1)"
"0","    )  "
"0","  })"
"0","###########"
"0","# sample transfering time "
"0","###########   "
"0","    time_data <- reactive({"
"0","      df <- df3() %>%"
"0","      filter(Date.Proc >= input$date_range2[[1]] & Date.Proc <= input$date_range2[[2]])"
"0","      df"
"0","    })"
"0","    "
"0","    output$plot_tl <- renderPlot({"
"0","      time_data()%>%"
"0","        mutate(Time.Rec = strftime(data.table::as.ITime(round_date(Rec, ""30 mins"")), ""%H:%M"") ) %>%"
"0","        group_by(Time.Rec) %>%"
"0","        arrange(Time.Rec) %>%"
"0","        summarise(Draw.to.Rec = mean(Draw.Rec))%>%"
"0","        ggplot()+"
"0","        geom_bar(aes(Time.Rec, Draw.to.Rec), stat = ""identity"")+"
"0","        theme("
"0","      #panel.grid.major = element_blank(), "
"0","      panel.grid.minor = element_blank(), "
"0","      #axis.title.y = element_blank(),"
"0","      #axis.text.y = element_blank(),"
"0","      panel.background = element_blank(),"
"0","      axis.text.x = element_text(angle = 90, hjust = 1)"
"0","    )"
"0","    })"
"0","    "
"0","    output$plot_t_site <- renderPlot({"
"0","      time_data()%>%"
"0","        group_by(Site) %>%"
"0","        summarise(Draw.to.Rec = mean(Draw.Rec))%>%"
"0","        ggplot()+"
"0","        geom_bar(aes(Site, Draw.to.Rec), stat = ""identity"")+"
"0","        theme("
"0","      #panel.grid.major = element_blank(), "
"0","      panel.grid.minor = element_blank(), "
"0","      #axis.title.y = element_blank(),"
"0","      #axis.text.y = element_blank(),"
"0","      panel.background = element_blank(),"
"0","      axis.text.x = element_text(angle = 90, hjust = 1)"
"0","    )"
"0","    })"
"0","    "
"0","    "
"0","    output$plot_t_trial <- renderPlot({"
"0","      time_data()%>%"
"0","        group_by(Trial) %>%"
"0","        summarise(Draw.to.Rec = mean(Draw.Rec))%>%"
"0","        arrange(desc(Draw.to.Rec)) %>%"
"0","        head(20)%>%"
"0","        ggplot()+"
"0","        geom_bar(aes(Trial, Draw.to.Rec), stat = ""identity"")+"
"0","        theme("
"0","      #panel.grid.major = element_blank(), "
"0","      panel.grid.minor = element_blank(), "
"0","      #axis.title.y = element_blank(),"
"0","      #axis.text.y = element_blank(),"
"0","      panel.background = element_blank(),"
"0","      axis.text.x = element_text(angle = 90, hjust = 1)"
"0","    )"
"0","    })"
"0","    "
"0","}"
